{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card p-4 shadow-sm">
            <h3 class="mb-3">Nueva Rese√±a</h3>
            
            <form action="/resenas/crear" method="post" enctype="multipart/form-data" onsubmit="return validarCoords()">
                
                <div class="mb-3">
                    <label class="form-label">Nombre Establecimiento</label>
                    <input type="text" name="nombre" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Direcci√≥n (Usa la lupa para localizar)</label>
                    <div class="input-group">
                        <input type="text" id="direccionInput" name="direccion" class="form-control" required placeholder="Ej: Calle Larios, M√°laga">
                        <button type="button" class="btn btn-secondary" onclick="geocodificar()">üîç Localizar GPS</button>
                    </div>
                    <small id="geoStatus" class="text-muted">Debes localizar la direcci√≥n antes de guardar.</small>
                </div>

                <input type="hidden" name="latitud" id="lat">
                <input type="hidden" name="longitud" id="lon">

                <div class="mb-3">
                    <label class="form-label">Valoraci√≥n (0-5)</label>
                    <input type="number" name="valoracion" min="0" max="5" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Imagen del Local</label>
                    <input type="file" name="imagen" class="form-control" accept="image/*">
                </div>

                <button type="submit" class="btn btn-success w-100">Publicar Rese√±a</button>
            </form>
        </div>
    </div>
</div>

<script>
function geocodificar() {
    var dir = document.getElementById('direccionInput').value;
    var status = document.getElementById('geoStatus');

    if(!dir) return;
    status.innerHTML = "‚åõ Buscando coordenadas...";

    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(dir)}`)
        .then(r => r.json())
        .then(d => {
            if(d.length > 0) {
                document.getElementById('lat').value = d[0].lat;
                document.getElementById('lon').value = d[0].lon;
                status.innerHTML = "‚úÖ Coordenadas encontradas: " + d[0].lat + ", " + d[0].lon;
                status.className = "text-success fw-bold";
            } else {
                status.innerHTML = "‚ùå Direcci√≥n no encontrada.";
                status.className = "text-danger";
            }
        });
}

function validarCoords() {
    if(!document.getElementById('lat').value) {
        alert("Por favor, pulsa la lupa üîç para obtener las coordenadas GPS antes de enviar.");
        return false;
    }
    return true;
}
</script>
{% endblock %}